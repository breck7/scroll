{"version":3,"file":"output-dir.js","sourceRoot":"","sources":["../../src/output-dir.ts"],"names":[],"mappings":"AAEA,OAAO,EAAE,iBAAiB,EAAE,MAAM,IAAI,CAAA;AACtC,OAAO,EAAE,UAAU,EAAE,MAAM,QAAQ,CAAA;AACnC,OAAO,EAAE,OAAO,EAAE,OAAO,EAAE,MAAM,MAAM,CAAA;AAEvC,4DAA4D;AAC5D,MAAM,CAAC,MAAM,SAAS,GAAG,CAAC,CAAM,EAAE,MAAoB,EAAE,EAAE;IACxD,MAAM,SAAS,GAAG,MAAM,CAAC,GAAG,CAAC,YAAY,CAAC,CAAA;IAC1C,MAAM,UAAU,GAAG,OAAO,CAAC,MAAM,CAAC,OAAO,EAAE,mBAAmB,CAAC,CAAA;IAC/D,CAAC,CAAC,EAAE,CAAC,OAAO,EAAE,OAAO,CAAC,EAAE,CAAC,KAAK,CAAC,OAAO,EAAE,UAAU,EAAE,SAAS,CAAC,CAAC,CAAA;AACjE,CAAC,CAAA;AAED,MAAM,KAAK,GAAG,CACZ,OAAc,EACd,UAAkB,EAClB,SAAkB,EAClB,EAAE;IACF,IAAI,SAAS,IAAI,SAAS,KAAK,UAAU,EAAE;QACzC,SAAS,CAAC,OAAO,EAAE,SAAS,CAAC,CAAA;KAC9B;IACD,SAAS,CAAC,OAAO,EAAE,UAAU,CAAC,CAAA;AAChC,CAAC,CAAA;AAED,MAAM,SAAS,GAAG,CAAC,OAAc,EAAE,GAAW,EAAE,EAAE;IAChD,MAAM,GAAG,GAAG,OAAO,CAAC,GAAG,EAAE,OAAO,CAAC,IAAI,GAAG,MAAM,CAAC,CAAA;IAC/C,UAAU,CAAC,OAAO,CAAC,GAAG,CAAC,CAAC,CAAA;IACxB,OAAO,CAAC,EAAE,CAAC,SAAS,EAAE,IAAI,CAAC,EAAE,CAC3B,IAAI,CAAC,MAAM,CAAC,IAAI,CAAC,iBAAiB,CAAC,GAAG,CAAC,CAAC,CACzC,CAAA;AACH,CAAC,CAAA","sourcesContent":["import { LoadedConfig } from '@tapjs/config'\nimport { Spawn, TAP } from '@tapjs/core'\nimport { createWriteStream } from 'fs'\nimport { mkdirpSync } from 'mkdirp'\nimport { dirname, resolve } from 'path'\n\n// Always write to .tap/test-results, plus the config if set\nexport const outputDir = (t: TAP, config: LoadedConfig) => {\n  const outputDir = config.get('output-dir')\n  const resultsDir = resolve(config.globCwd, '.tap/test-results')\n  t.on('spawn', subtest => pipes(subtest, resultsDir, outputDir))\n}\n\nconst pipes = (\n  subtest: Spawn,\n  resultsDir: string,\n  outputDir?: string\n) => {\n  if (outputDir && outputDir !== resultsDir) {\n    pipeToDir(subtest, outputDir)\n  }\n  pipeToDir(subtest, resultsDir)\n}\n\nconst pipeToDir = (subtest: Spawn, dir: string) => {\n  const out = resolve(dir, subtest.name + '.tap')\n  mkdirpSync(dirname(out))\n  subtest.on('process', proc =>\n    proc.stdout.pipe(createWriteStream(out))\n  )\n}\n"]}