{"version":3,"file":"node-options-env.js","sourceRoot":"","sources":["../../src/node-options-env.ts"],"names":[],"mappings":"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","sourcesContent":["import { argvToNodeOptions } from './argv-to-node-options.js'\nimport {\n  importLoader,\n  importMatch,\n  legacyLoader,\n  legacyMatch,\n} from './loader-paths.js'\nimport { nodeOptionsToArgv } from './node-options-to-argv.js'\n\nimport Module from 'node:module'\n\nconst getKeyValue = (\n  args: readonly string[],\n  i: number\n): [boolean, string, string | undefined] => {\n  const arg = args[i]\n  /* c8 ignore start */\n  if (typeof arg !== 'string') throw new Error('invalid arg')\n  /* c8 ignore stop */\n  if (arg.includes('=')) {\n    const [k, ...rest] = arg.split('=') as [string, ...string[]]\n    return [true, k, rest.join('=')]\n  } else if (i < args.length - 1) {\n    return [false, arg, args[i + 1]]\n  } else {\n    return [false, arg, undefined]\n  }\n}\n\nconst useImport = !!(Module as { register?: (...a: any[]) => any })\n  .register\n\n// JUST test if we need to do anything at all with the env.\n// if the loader is set already in the args, even incorrectly, return true\nconst hasLoader = (args: readonly string[]): boolean => {\n  for (let i = 0; i < args.length; i++) {\n    const arg = args[i]\n    /* c8 ignore start */\n    if (typeof arg !== 'string') throw new Error('invalid arg')\n    /* c8 ignore stop */\n    if (!arg.startsWith('--') || arg === '--') break\n    const [eq, k, v] = getKeyValue(args, i)\n    if (!v) {\n      // wasn't a key-value pair\n      continue\n    }\n    if (!eq) i++\n    if (\n      (k === '--experimental-loader' || k === '--loader') &&\n      legacyMatch(v)\n    ) {\n      return true\n    }\n    if (k === '--import' && importMatch(v)) return true\n  }\n  return false\n}\n\nconst rmLoader = (args: string[]) => {\n  const doNotWantKeys = ['--experimental-loader', '--loader', '--import']\n\n  const result: string[] = []\n\n  let doubledash = false\n  for (let i = 0; i < args.length; i++) {\n    const arg = args[i]\n    /* c8 ignore start */\n    if (typeof arg !== 'string') throw new Error('invalid arg')\n    /* c8 ignore stop */\n    if (!arg.startsWith('--') || doubledash) {\n      result.push(arg)\n      continue\n    }\n    if (arg === '--') {\n      result.push(arg)\n      doubledash = true\n      continue\n    }\n\n    const [eq, k, v] = getKeyValue(args, i)\n    if (!v) {\n      // wasn't a key-value pair\n      result.push(arg)\n      continue\n    }\n    if (!eq) i++\n    if (doNotWantKeys.includes(k) && (importMatch(v) || legacyMatch(v))) {\n      // it's ours, remove it\n      continue\n    }\n    // not ours, leave it\n    result.push(arg)\n    const next = args[i]\n    if (!eq && typeof next === 'string') result.push(next)\n    continue\n  }\n  return result\n}\n\nconst addLoader = (args: string[]) => {\n  const addKey = useImport ? '--import' : '--loader'\n  const addValue = useImport ? importLoader : legacyLoader\n  const doNotWantKeys = [\n    '--experimental-loader',\n    useImport ? '--loader' : '--import',\n  ]\n  const test = useImport ? importMatch : legacyMatch\n\n  const result: string[] = []\n\n  let doubledash = false\n  let found = false\n  for (let i = 0; i < args.length; i++) {\n    const arg = args[i]\n    /* c8 ignore start */\n    if (typeof arg !== 'string') throw new Error('invalid arg')\n    /* c8 ignore stop */\n    if (!arg.startsWith('--') || doubledash) {\n      result.push(arg)\n      continue\n    }\n    if (arg === '--') {\n      result.push(arg)\n      doubledash = true\n      continue\n    }\n\n    const [eq, k, v] = getKeyValue(args, i)\n    if (!v) {\n      // wasn't a key-value pair\n      result.push(arg)\n      continue\n    }\n    if (!eq) i++\n    if (doNotWantKeys.includes(k) && (importMatch(v) || legacyMatch(v))) {\n      // it's ours, but not how we want it, omit\n      continue\n    }\n\n    if (k === addKey && test(v)) {\n      // already present, don't let it be set multiple times.\n      if (found) continue\n      found = true\n      result.push(arg)\n      const next = args[i]\n      if (!eq && typeof next === 'string') result.push(next)\n    } else {\n      // not ours\n      result.push(arg)\n      const next = args[i]\n      if (!eq && typeof next === 'string') result.push(next)\n      continue\n    }\n  }\n  if (!found) result.push(`${addKey}=${addValue}`)\n  return !useImport ? addIgnoreLoadersWarning(result) : result\n}\n\nconst addIgnoreLoadersWarning = (args: readonly string[]) =>\n  args.includes('--no-warnings') ||\n  args.includes('--no-warnings=ExperimentalLoader')\n    ? args\n    : args.concat('--no-warnings')\n\nexport const nodeOptionsEnv = (\n  env: NodeJS.ProcessEnv,\n  args: readonly string[]\n) => {\n  // if we already have the loader in args, don't add to NODE_OPTIONS\n  const no = nodeOptionsToArgv(env.NODE_OPTIONS)\n  return argvToNodeOptions(hasLoader(args) ? rmLoader(no) : addLoader(no))\n}\n"]}