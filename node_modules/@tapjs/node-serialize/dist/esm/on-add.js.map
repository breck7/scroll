{"version":3,"file":"on-add.js","sourceRoot":"","sources":["../../src/on-add.ts"],"names":[],"mappings":"AAGA,OAAO,EAAE,kBAAkB,EAAE,MAAM,2BAA2B,CAAA;AAE9D,MAAM,CAAC,MAAM,OAAO,GAAG,CACrB,OAA6C,EAC7C,QAAmC,EACnC,OAAwB,EACxB,EAAE;IACF,MAAM,KAAK,GAAG,CAAC,CAAO,EAAE,EAAE;QACxB,MAAM,EAAE,GAAG,CAAa,CAAA;QACxB,MAAM,IAAI,GAAW,EAAE,CAAA;QACvB,MAAM,KAAK,GAAqB,QAAQ,CAAC,GAAG,CAAC,CAAC,CAAC,IAAI,EAAE,CAAA;QACrD,OAAO,CAAC,GAAG,CAAC,CAAC,EAAE,IAAI,CAAC,CAAA;QACpB,QAAQ,CAAC,GAAG,CAAC,CAAC,EAAE,KAAK,CAAC,CAAA;QAEtB,IAAI,OAAO,EAAE,CAAC,OAAO,KAAK,UAAU,EAAE;YACpC,EAAE,CAAC,OAAO,GAAG,OAAO,CAAA;SACrB;aAAM,IAAI,CAAC,EAAE,CAAC,OAAO,EAAE;YACtB,CAAC,CAAC,MAAM,CAAC,EAAE,CAAC,SAAS,EAAE,OAAO,CAAC,EAAE;gBAC/B,OAAO,GAAG,OAAO,CAAC,OAAO,CAAC,IAAI,EAAE,EAAE,CAAC,CAAC,IAAI,EAAE,CAAA;gBAC1C,KAAK,CAAC,IAAI,CAAC,EAAE,GAAG,kBAAkB,CAAC,CAAC,CAAC,EAAE,OAAO,EAAE,CAAC,CAAA;YACnD,CAAC,CAAC,CAAA;SACH;QACD,EAAE,CAAC,EAAE,CAAC,YAAY,EAAE,KAAK,CAAC,CAAA;QAC1B,IAAI,CAAC,CAAC,MAAM,EAAE;YACZ,OAAO,CAAC,GAAG,CAAC,CAAC,CAAC,MAAM,CAAC,EAAE,IAAI,CAAC,CAAC,CAAC,CAAA;SAC/B;IACH,CAAC,CAAA;IACD,OAAO,KAAK,CAAA;AACd,CAAC,CAAA","sourcesContent":["import { Base, TestBase } from '@tapjs/core'\nimport { DiagnosticData } from '@tapjs/error-serdes'\nimport { TestMap } from './test-map.js'\nimport { testNestedLocation } from './test-nested-location.js'\n\nexport const onAddFn = (\n  comment: (this: Base, ...args: any[]) => void,\n  diagsMap: TestMap<DiagnosticData[]>,\n  subsMap: TestMap<Base[]>\n) => {\n  const onAdd = (t: Base) => {\n    const tt = t as TestBase\n    const subs: Base[] = []\n    const diags: DiagnosticData[] = diagsMap.get(t) || []\n    subsMap.set(t, subs)\n    diagsMap.set(t, diags)\n\n    if (typeof tt.comment === 'function') {\n      tt.comment = comment\n    } else if (!tt.comment) {\n      t.parser.on('comment', message => {\n        message = message.replace(/^#/, '').trim()\n        diags.push({ ...testNestedLocation(t), message })\n      })\n    }\n    tt.on('subtestAdd', onAdd)\n    if (t.parent) {\n      subsMap.get(t.parent)?.push(t)\n    }\n  }\n  return onAdd\n}\n"]}